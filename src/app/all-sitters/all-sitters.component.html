<grape-filter-sitters></grape-filter-sitters>

  <div class="error" *ngIf="error$ | async">
    <div class="error_ops">Ooops!</div>
    Something wrong. Please try again later.
  </div>
  <ng-container *ngIf="sitters$ | async">
    <mat-card class="sitter" *ngFor="let sitter of sitters$ | async">
      <div class="img">
        <ng-container *ngIf="sitter.photo; else defaultPhoto">
          <img mat-card-image [src]="sitter.photo" alt="photo" />
          <div class="rate">
            <ngx-stars [readonly]="activeId && sitter.userId !== activeId ? false : true" [maxStars]="5" [initialStars]="sitter.rate"
            [color]="'#FFC92A'" [wholeStars]="false" (ratingOutput)="onRatingSet(sitter.userId, $event)"></ngx-stars>
            <div *ngIf="sitter.rate > 0.4" class="rate_num">Rate: {{sitter.rate | number:'1.0-1'}}</div>
          </div>
        </ng-container>
        <ng-template #defaultPhoto>
          <img
            mat-card-image
            src="../../assets/img/default-user.png"
            alt="photo"
          />
        </ng-template>
      </div>

      <mat-tab-group dynamicHeight (focusChange)="getBookStatus(sitter.userId)" class="tab-group">
        <mat-tab label="Sitter Info">
          <mat-card-content class="description">
            <mat-card-title class="name">
              <i class="material-icons">person_pin</i>
              {{ sitter.userName }}
            </mat-card-title>
            <mat-card-content class="information">
              <div class="payment">
                <i class="material-icons">attach_money</i>
                {{ sitter.payment | currency }} per hour
              </div>
              <div class="location">
                <i class="material-icons">location_on</i>
                {{ sitter.address }}
              </div>
              <div class="animals">
                <i class="material-icons">pets</i>
                {{ sitter.animals.join(', ') }}
              </div>
              <div class="services">
                <i class="material-icons">room_service</i>
                {{ sitter.services.join(', ') }}
              </div>
              <div class="about">
                <i class="material-icons"> create</i>
                {{ sitter.information }}
              </div>
            </mat-card-content>
            <button
              class="btn"
              mat-raised-button
              color="primary"
              (click)="onShow(sitter.userId)"
            >
              <i class="material-icons">pets</i>Show comments
            </button>

            <div *ngIf="isShowComments && sitter.userId === currentSitterCommentId">
              <h2>Comments</h2>
              <mat-divider style="width: 87%;"></mat-divider>
              <mat-form-field class="comment">
                <mat-label>Leave a comment</mat-label>
                <input [disabled]="sitter.userId === activeId"
                      #newComment matInput maxlength="100" #message />
                <mat-hint align="start">{{ message.value.length }} / 100</mat-hint>
              </mat-form-field>
              <button
                mat-raised-button
                (click)="
                  onSubmit(newComment.value, sitter.userId); newComment.value = ''
                "
                [disabled]="sitter.userId === activeId"
              ><i class="material-icons" style="margin-right: 5px;">comment</i>
                Add comment
              </button>
              <div *ngIf="isShowComments && comments.length > 0" class="comments">
                <mat-card *ngFor="let comment of comments" class="comments_block">
                  <div>
                    <img mat-card-image src="../../assets/img/default-user.png" alt="user">
                  </div>
                  <div *ngIf="comment.userId === sitter.userId">
                    <span>{{ comment.name }}</span>
                    <p>{{ comment.comment }}</p>
                  </div>
                </mat-card>
              </div>
            </div>
          </mat-card-content>
        </mat-tab>
        <mat-tab  label="Book">
          <div style="width: 80%; margin: 20px auto; text-align: center;">
            <h1 *ngIf="isBooked && sitter.userId === bookId; else notBooked">
              <i style="font-size: 2em;" class="material-icons">work_off</i>
              Sorry, this sitter is busy now.
            </h1>
          </div>
          <ng-template #notBooked>
            <div style="width: 80%; margin: 20px auto; text-align: center;">
              <h1><i style="font-size: 2em;" class="material-icons">work</i>
                Sitter is free now. You can book him.
              </h1>
            </div>
            <mat-accordion >
              <mat-expansion-panel style="width: 80%; margin: 20px auto;"
                (opened)="panelOpenState = true"
                (closed)="panelOpenState = false">
                <mat-expansion-panel-header>
                  <mat-panel-title>Booking form</mat-panel-title>
                  <mat-panel-description>Leave your contact info below</mat-panel-description>
                </mat-expansion-panel-header>
                <mat-form-field class="book">
                  <mat-label>You can write here</mat-label>
                  <textarea #newBook style="resize: none;"
                            rows="4" cols="50" matInput maxlength="200" #message
                            [disabled]="sitter.userId === activeId || isBooked"></textarea>
                  <mat-hint align="end">{{ message.value.length }} / 200</mat-hint>
                </mat-form-field>
                <button
                    (click)="onBook(newBook.value, sitter.userId, sitter.userName); newBook.value=''"
                    mat-raised-button
                    [disabled]="sitter.userId === activeId || isBooked || newBook.value===''">
                <i class="material-icons">pets</i>Book Sitter
                </button>
              </mat-expansion-panel>
            </mat-accordion>
          </ng-template>
        </mat-tab>
      </mat-tab-group>
    </mat-card>
  </ng-container>
